<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doc Check Parser Pro</title>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-RDVPFB5PML"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-RDVPFB5PML');
    </script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/compromise"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Download = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>);
        const FileSpreadsheet = () => (<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>);
        const Mic = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>);

        const CARRIER_MAP = {
            'estes': 'EXLA', 'estates': 'EXLA', 'abf': 'ABFS',
            'aaa cooper': 'AACT', 'cooper': 'AACT', 'old dominion': 'ODFL',
            'od': 'ODFL', 'global': 'GLBL', 'southeastern': 'SEFL',
            'sefl': 'SEFL', 'fedex': 'FXFE', 'fed ex': 'FXFE',
            'amazon': 'AMAZON', 'azng': 'AZNG', 'ms': 'MSOH', 'fedex': 'FXFE', 'Fedex' :'FXFE'
        };

        const DocCheckParser = () => {
            const [input, setInput] = useState('');
            const [status, setStatus] = useState('Full');
            const [allEntries, setAllEntries] = useState([]);
            const [isListening, setIsListening] = useState(false);
            const [transcript, setTranscript] = useState('');
            const recognitionRef = useRef(null);

            useEffect(() => {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) return;
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.onresult = (event) => {
                    let interim = '', final = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        if (event.results[i].isFinal) final += event.results[i][0].transcript + ' ';
                        else interim += event.results[i][0].transcript;
                    }
                    if (final) { setInput(prev => prev + final.trim() + '\n'); setTranscript(''); }
                    else { setTranscript(interim); }
                };
                recognition.onend = () => { if (isListening) recognition.start(); };
                recognitionRef.current = recognition;
            }, [isListening]);

            const parseMessage = (text, currentStatus) => {
                const lines = text.trim().split('\n');
                return lines.map(line => {
                    const doc = nlp(line.toLowerCase());
                    
                    // Improved Door Detection ("Dock Door", "Door", "DD")
                    let doorVal = '';
                    let doorMatch = doc.match('(dock door|door|dd) #').terms(-1).text();
                    
                    if (!doorMatch) {
                        let firstNum = doc.numbers().first().get(0);
                        if (firstNum && firstNum < 200) doorMatch = firstNum;
                    }
                    if (doorMatch) {
                        const cleanNum = String(doorMatch).replace(/\D/g, '');
                        doorVal = `DD${cleanNum.padStart(3, '0')}`;
                    }

                    // Trailer Detection
                    let trailerVal = '';
                    let possibleTrailers = doc.numbers().filter(n => n.get(0) > 1000).text();
                    if (!possibleTrailers) {
                        let match = line.match(/\b([A-Z]{2,4}\d{4,7}|\d{5,8})\b/i);
                        trailerVal = match ? match[0].toUpperCase() : '';
                    } else {
                        trailerVal = possibleTrailers.split(' ')[0];
                    }

                    // Carrier Logic
                    let scac = '';
                    for (const [nickname, code] of Object.entries(CARRIER_MAP)) {
                        if (doc.has(nickname)) { scac = code; break; }
                    }

                    // Load Type
                    let type = '';
                    if (doorVal) {
                        const num = parseInt(doorVal.replace(/\D/g,''));
                        type = (num >= 50 && num <= 72) ? 'LTL' : (num >= 80 && num <= 106) ? 'TL' : '';
                    }

                    return {
                        door: doorVal,
                        trailer: trailerVal,
                        carrier: scac,
                        loadType: type,
                        status: currentStatus,
                        timestamp: new Date().toLocaleString()
                    };
                }).filter(e => e.door || e.trailer);
            };

            const handleParse = () => {
                if (!input.trim()) return;
                const newParsed = parseMessage(input, status);
                setAllEntries(prev => [...prev, ...newParsed]);
                setInput('');
            };

            const exportReport = () => {
                const data = allEntries.map(e => ({
                    'Date/Time': e.timestamp, 'Door': e.door, 'Carrier': e.carrier,
                    'Trailer': e.trailer, 'Load Type': e.loadType, 'Status': e.status
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Dock Checks");
                XLSX.writeFile(wb, `DockCheck_${new Date().toLocaleDateString()}.xlsx`);
            };

            return (
                <div className="min-h-screen bg-gray-50 p-6">
                    <div className="max-w-5xl mx-auto bg-white rounded-xl shadow-lg p-8">
                        <div className="flex justify-between items-center mb-8 border-b pb-4">
                            <div className="flex items-center gap-3">
                                <FileSpreadsheet />
                                <h1 className="text-2xl font-bold text-gray-800">Dock Check Pro</h1>
                            </div>
                            <button onClick={exportReport} className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2">
                                <Download /> Export ({allEntries.length})
                            </button>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-2">Trailer Status</label>
                                <select value={status} onChange={(e) => setStatus(e.target.value)} className="w-full p-3 border-2 border-indigo-200 rounded-lg">
                                    <option value="Full">Full (Loaded)</option>
                                    <option value="Empty">Empty (Available)</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-2">Voice Input</label>
                                <button onClick={() => { if (isListening) recognitionRef.current?.stop(); else recognitionRef.current?.start(); setIsListening(!isListening); }} 
                                        className={`w-full py-3 rounded-lg font-bold transition-all ${isListening ? 'bg-red-500 text-white animate-pulse' : 'bg-indigo-600 text-white'}`}>
                                    {isListening ? "Stop Recording" : "Start Voice Input"}
                                </button>
                            </div>
                        </div>

                        <div className="mb-6">
                            {isListening && transcript && <div className="text-indigo-600 italic text-sm mb-1">Hearing: {transcript}</div>}
                            <textarea value={input} onChange={(e) => setInput(e.target.value)} className="w-full h-32 p-4 border-2 border-gray-200 rounded-lg" placeholder="Example: Dock door 5 has trailer 5055 with Estes..." />
                        </div>

                        <div className="flex gap-4 mb-8">
                            <button onClick={handleParse} className="bg-indigo-700 text-white px-8 py-3 rounded-lg font-bold">Add to Log</button>
                            <button onClick={() => setAllEntries([])} className="text-gray-400 hover:text-red-500 font-semibold">Reset History</button>
                        </div>

                        {allEntries.length > 0 && (
                            <div className="overflow-hidden border rounded-lg">
                                <table className="w-full text-left">
                                    <thead className="bg-gray-100">
                                        <tr>
                                            <th className="p-3 text-xs font-bold uppercase">Door</th>
                                            <th className="p-3 text-xs font-bold uppercase">Trailer</th>
                                            <th className="p-3 text-xs font-bold uppercase">Carrier</th>
                                            <th className="p-3 text-xs font-bold uppercase">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y">
                                        {allEntries.slice().reverse().map((e, i) => (
                                            <tr key={i} className="hover:bg-gray-50">
                                                <td className="p-3 font-mono font-bold text-indigo-600">{e.door || '??'}</td>
                                                <td className="p-3 font-semibold">{e.trailer || '??'}</td>
                                                <td className="p-3 font-bold">{e.carrier || '-'}</td>
                                                <td className="p-3">
                                                    <span className={`px-2 py-1 rounded text-xs font-bold ${e.status === 'Full' ? 'bg-orange-100 text-orange-700' : 'bg-green-100 text-green-700'}`}>
                                                        {e.status}
                                                    </span>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<DocCheckParser />, document.getElementById('root'));
    </script>
</body>
</html>
</html>

