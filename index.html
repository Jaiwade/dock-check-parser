<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doc Check Parser Pro</title>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-RDVPFB5PML"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-RDVPFB5PML');
    </script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/compromise"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const CARRIER_MAP = {
            'estes': 'EXLA', 'estates': 'EXLA', 'abf': 'ABFS',
            'aaa cooper': 'AACT', 'cooper': 'AACT', 'old dominion': 'ODFL',
            'od': 'ODFL', 'global': 'GLBL', 'southeastern': 'SEFL',
            'sefl': 'SEFL', 'fedex': 'FXFE', 'fed ex': 'FXFE',
            'amazon': 'AMAZON', 'azng': 'AZNG', 'ms': 'MSOH'
        };

        const DocCheckParser = () => {
            const [input, setInput] = useState('');
            const [status, setStatus] = useState('Full');
            const [allEntries, setAllEntries] = useState([]);
            const [error, setError] = useState('');
            const [isListening, setIsListening] = useState(false);
            const [transcript, setTranscript] = useState('');
            const recognitionRef = useRef(null);

            useEffect(() => {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) return;
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.onresult = (event) => {
                    let interim = '', final = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        if (event.results[i].isFinal) final += event.results[i][0].transcript + ' ';
                        else interim += event.results[i][0].transcript;
                    }
                    if (final) { setInput(prev => prev + final.trim() + '\n'); setTranscript(''); }
                    else { setTranscript(interim); }
                };
                recognition.onend = () => { if (isListening) recognition.start(); };
                recognitionRef.current = recognition;
            }, [isListening]);

            const parseMessage = (text, currentStatus) => {
                const lines = text.split('\n').filter(l => l.trim() !== '');
                
                return lines.map(line => {
                    const cleanLine = line.toLowerCase().trim();
                    
                    // 1. DOOR DETECTION (Strict & Robust)
                    let doorVal = '';
                    // Match "DD052", "DD 52", "Door 52", "Dock Door 52"
                    const doorRegex = /(?:door|dd|dock door)\s*#?(\d{1,3})/i;
                    const doorMatch = cleanLine.match(doorRegex);
                    
                    if (doorMatch) {
                        const num = doorMatch[1];
                        doorVal = `DD${num.padStart(3, '0')}`;
                    } else {
                        // Fallback: If no keywords, look for a standalone 1-3 digit number
                        const standAloneNum = cleanLine.match(/\b(\d{1,3})\b/);
                        if (standAloneNum && parseInt(standAloneNum[1]) < 200) {
                            doorVal = `DD${standAloneNum[1].padStart(3, '0')}`;
                        }
                    }

                    // 2. TRAILER DETECTION (Min 4 digits, ignore the door number)
                    let trailerVal = '';
                    const trailerRegex = /\b([A-Z]{0,4}\d{4,8})\b/i;
                    const tMatch = cleanLine.match(trailerRegex);
                    if (tMatch) {
                        trailerVal = tMatch[0].toUpperCase();
                    }

                    // 3. CARRIER MAPPING
                    let scac = '';
                    for (const [nickname, code] of Object.entries(CARRIER_MAP)) {
                        if (cleanLine.includes(nickname)) {
                            scac = code;
                            break;
                        }
                    }

                    // 4. LOAD TYPE
                    let type = '';
                    if (doorVal) {
                        const num = parseInt(doorVal.replace(/\D/g,''));
                        type = (num >= 50 && num <= 72) ? 'LTL' : (num >= 80 && num <= 106) ? 'TL' : 'Other';
                    }

                    return { 
                        door: doorVal, 
                        trailer: trailerVal, 
                        carrier: scac, 
                        loadType: type, 
                        status: currentStatus, 
                        timestamp: new Date().toLocaleString() 
                    };
                }).filter(e => e.door || e.trailer);
            };

            const handleParse = () => {
                if (!input.trim()) return;
                const newParsed = parseMessage(input, status);
                if (newParsed.length === 0) {
                    setError("Couldn't find a Door. Try 'DD052' or 'Door 52'");
                    return;
                }
                setAllEntries(prev => [...newParsed, ...prev]);
                setInput('');
                setError('');
            };

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-6">
                        <h1 className="text-xl font-bold mb-4 border-b pb-2">Dock Check Pro</h1>
                        
                        {error && <div className="bg-red-100 text-red-700 p-2 mb-4 rounded text-sm">{error}</div>}

                        <div className="grid grid-cols-2 gap-4 mb-4">
                            <select value={status} onChange={(e) => setStatus(e.target.value)} className="p-3 border rounded-lg bg-white">
                                <option value="Full">Full (Loaded)</option>
                                <option value="Empty">Empty (Available)</option>
                            </select>
                            <button onClick={() => { if (isListening) recognitionRef.current?.stop(); else recognitionRef.current?.start(); setIsListening(!isListening); }} 
                                    className={`p-3 rounded-lg font-bold ${isListening ? 'bg-red-500 text-white animate-pulse' : 'bg-indigo-600 text-white'}`}>
                                {isListening ? "‚èπ Stop" : "üé§ Voice"}
                            </button>
                        </div>

                        <textarea value={input} onChange={(e) => setInput(e.target.value)} className="w-full h-20 p-3 border rounded-lg mb-4" placeholder="Type 'DD052' or speak..." />

                        <button onClick={handleParse} className="w-full bg-indigo-700 text-white py-3 rounded-lg font-bold mb-6">Add to Log</button>

                        <div className="overflow-hidden border rounded-lg">
                            <table className="w-full text-left">
                                <thead className="bg-gray-100 text-[10px] uppercase font-bold text-gray-500">
                                    <tr>
                                        <th className="p-3">Door</th>
                                        <th className="p-3">Trailer</th>
                                        <th className="p-3">Carrier</th>
                                        <th className="p-3">Status</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {allEntries.map((e, i) => (
                                        <tr key={i} className="text-sm">
                                            <td className="p-3 font-mono font-bold text-indigo-700">{e.door || '??'}</td>
                                            <td className="p-3 font-semibold">{e.trailer || '-'}</td>
                                            <td className="p-3 font-bold">{e.carrier || '-'}</td>
                                            <td className="p-3">
                                                <span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase ${e.status === 'Full' ? 'bg-orange-100 text-orange-700' : 'bg-green-100 text-green-700'}`}>
                                                    {e.status}
                                                </span>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<DocCheckParser />, document.getElementById('root'));
    </script>
</body>
</html>


